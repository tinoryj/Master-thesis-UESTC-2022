\section{\sysnameS 实现}
\label{sec:sgxdedup-implementation}

本文基于OpenSSL 1.1.1l\citing{openssl}、SGX SDK 2.15\citing{sgxsdk} 、和Intel SGX SSL\citing{sgxssl}使用C++实现了一个\sysnameS 原型系统。本文的原型系统通过SHA-256哈希函数实现明文和密文数据块的指纹计算和识别等操作，并通过AES-256加密算法实现基于数据块的加密机制。原型系统约包含14,200行代码。原型系统源码及操作指南开源于：\href{https://github.com/tinoryj/SGXDedup}{https://github.com/tinoryj/SGXDedup}。

\paragraph*{原型系统结构。}
\sysnameS 采用了客户端、密钥服务器、存储服务器(云服务端)的客户端/服务器结构。在客户端中，将文件读取及数据块分割、明文数据块指纹计算及密钥生成、数据块加密、数据块所有权证明(部署于所有权证明安全区中)、非重复数据块发送等五个模块进行了并行化设计，通过无锁队列在各个模块之间传递待处理的数据块；在密钥服务器中，使用单个密钥安全区并通多线程方式为多个客户端提供密钥生成服务；在云服务端，对每个客户端中的所有权证明安全区和密钥服务器中的密钥安全区进行基于Intel IAS服务的远程认证\citing{sgxEPID}，通过验证的客户端提供数据块所有权校验和重复数据删除查询服务，并最终存储所有客户端提供的非重复密文数据块。相关原型系统代码结构分析见\S\ref{sec:appendix-prototype}

\paragraph*{原型系统初始化。}
为了启动密钥安全区，云服务端将对其用于全局秘密生成的子秘密(\S\ref{subsec:sgxdedup-enclave-management})和会话密钥种子(\S\ref{subsec:sgxdedup-key-management})硬编码到密钥安全区动态运行库中。\sysnameS 中云服务端也可以在验证密钥安全区后再通过安全信道向密钥安全区装载子秘密和会话密钥种子(使用SGX\citing{sgx}的秘密提供(Secret provisioning)功能)，但会产生额外的启动开销。密钥安全区使用SHA-256哈希算法生成全局秘密并在密钥回归中进行密钥状态更新和会话密钥导出。所有权证明安全区在NIST P-256椭圆曲线\citing{nist}上实现DHKE，以与云服务端共享PoW密钥。

\paragraph*{密钥生成。}密钥服务器接收客户端发送的经由会话密钥加密的明文数据块指纹，在密钥安全区中解密并基于明文数据块指纹和密钥安全区中的全局秘密使用SHA-256哈希算法生成每个明文数据块指纹对应的消息锁加密密钥。最后将得到的消息锁加密密钥通过会话密钥加密后传回客户端。此外，为了实现基于TEE的推测性加密(\S\ref{subsec:sgxdedup-encryption})，本文将nonce和计数器长度分别固定为12字节和4字节，并使用HMAC-SHA-256实现消息认证算法。同时，为了防止恶意客户端使用过期的会话密钥进行密钥生成等操作，客户端与密钥安全区之间通过安全信道传输的所有数据内容(包括：数据块指纹、生成的密钥、初始化所用的nonce和计数器等)均基于会话密钥产生哈希消息认证码，用于检验传输的数据。

\paragraph*{重复数据删除。}每个客户端实现了基于Rabin指纹\citing{rabin81}的内容定义的数据块分块算法。本文将可变大小分块算法中的最小、平均和最大数据块大小分别固定为4\,KiB，8\,KiB和16\,KiB。在此基础上，\sysnameS 实现了数据块级源端重复数据删除与数据块级所有权证明的结合。所有权证明安全区实现了所有权证明安全区内部调用(\textit{Proof generation ECall})来计算密文数据块的指纹，并使用AES-CMAC算法基于初始化过程中产生的PoW密钥对生成的指纹生进行签名。云服务端基于LevelDB\citing{leveldb}键值对数据库实现重复数据删除指纹索引(\S\ref{subsec:sgxdedup-problem})。为了降低网络和磁盘I/O开销，本文将非重复密文数据块整合在最大大小为8\,MiB的容器中，作为数据块的网络传输和云服务端存储的基本单位\citing{lillibridge13}。

\paragraph*{系统优化。}为了减少频繁进出安全区导致的CPU上下文切换和安全区内存加密/解密开销，每个客户端批量处理多个明文数据块指纹(默认为4,096个)进行密钥生成请求并在与密钥安全区(\S\ref{subsec:sgxdedup-encryption})之间的安全信道中传输。密钥安全区通过指针访问未受保护的内存读取数据块指纹进行批量消息锁加密密钥生成，而不将指纹内容复制到安全区\citing{harnik2018SGX}。类似地，所有权证明安全区按批次(默认大小为4,096)处理密文数据块且不复制密文数据块内容到安全区内。本文还使用多线程来提高性能，每个客户端通过多线程并行处理文件分块、明文数据块计算、密钥生成及加密、所有权证明和非重复数据块及元数据上传。同时，密钥安全区和云服务端使用不同线程处理多个客户端的连接。